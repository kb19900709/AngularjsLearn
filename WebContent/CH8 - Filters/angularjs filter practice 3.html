<!DOCTYPE html>
<html ng-app="kbApp">
<head>
<script src="https://ajax.googleapis.com/ajax/libs/angularjs/1.5.0/angular.min.js"></script>
  <meta charset="utf-8">
  <title>CH8</title>
</head>
<body ng-controller="MainCtrl as ctrl">
  Test date : <input type="date" ng-model="ctrl.testObj.date">
  <br><br>
  Test uppercase : <input type="text" ng-model="ctrl.testObj.uppercase">
  <br><br>
  Test custom filter(non filter) : <sapn ng-bind="ctrl.customTime"></sapn><br>
  Test custom filter(filter) : <sapn ng-bind="ctrl.customTime | calculateTime"></sapn>
  <br><br>
  <button ng-click="ctrl.getTestObj()">get test obj</button>&emsp;
  <script>
    var kbApp = angular.module('kbApp',[]);
    kbApp.controller('MainCtrl',['dateFilter','uppercaseFilter','calculateTimeFilter',function(dateFilter,uppercaseFilter,calculateTimeFilter){
      var dateFormatPattern = 'yyyy/MM/dd';
      var self = this;
      self.customTime = new Date(2016, 8, 9);
      self.testObj = {
        date : null
        ,uppercase : null
      }
      
      self.getTestObj = function(){
        var tempObj = angular.copy(self.testObj);
        if(tempObj.date){
          tempObj.dateAfterFilter = calculateTimeFilter(tempObj.date);
          tempObj.date = dateFilter(tempObj.date,dateFormatPattern);
        }
        if(tempObj.uppercase){
          tempObj.uppercase = uppercaseFilter(tempObj.uppercase);
        }
        alert(JSON.stringify(tempObj));
      }
    }]);
    
    kbApp.filter('calculateTime',['numberFilter',function(numberFilter){
      
      var oneDay = 1000*60*60*24;
      var oneMonth = oneDay*30;
      var oneYear = oneDay*365;
      
      var dateMap = {
        day:'天'
        ,month:'月'
        ,year:'年'
      }
      
      function genResultString(result,unit){
        var number = result>0?result:-result;
        var unitFormat = dateMap[unit || 'day'];
        var ab = result>0?'前':'後';
        return number+unitFormat+ab;
      }
      
      return function(ts,unit){
        var now = new Date().getTime();
        var target = ts.getTime();
        var result;
        switch(unit || 'day'){
          case 'day':
            result = numberFilter((now-target)/oneDay,2);
            break;
          case 'month' :
            result = numberFilter((now-target)/oneMonth,2);
            break;
          case 'year' :
            result = numberFilter((now-target)/oneYear,2);
            break;
        }
        return genResultString(result,unit);
      }
    }]);
  </script>
</body>
</html>